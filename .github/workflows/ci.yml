name: Shortlink Frontend CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # Phase 1: Lint & Type Check (Fast - ~1 min)
  # ============================================
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: TypeScript Check
        run: npx tsc --noEmit

  # ============================================
  # Phase 2: Unit Tests (Fast - ~2 min)
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Unit Tests
        run: npm run test:unit -- --maxWorkers=2
        env:
          CI: true

      - name: Upload Unit Test Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unit
          fail_ci_if_error: false

  # ============================================
  # Phase 3: Integration Tests (Medium - ~5 min)
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-and-typecheck, unit-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Integration Tests
        run: npm run test:integration -- --maxWorkers=2
        env:
          CI: true
        continue-on-error: true  # Allow to continue if no integration tests exist yet

  # ============================================
  # Phase 4: Smoke Tests (Very Fast - ~30 sec)
  # ============================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [unit-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Smoke Tests
        run: npm run test:smoke -- --maxWorkers=2
        env:
          CI: true
        continue-on-error: true  # Allow to continue if no smoke tests exist yet

  # ============================================
  # Phase 5: Visual Regression Tests (Storybook + Playwright)
  # ============================================
  visual-regression-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-and-typecheck, unit-tests, integration-tests]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Build Storybook
        run: npm run build-storybook
        env:
          CI: true

      - name: Run Visual Regression Tests
        run: npm run test:visual
        env:
          CI: true
        continue-on-error: true  # Don't fail CI if visual tests fail, but still upload report

      - name: Upload Playwright HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-html-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload Test Results (for debugging)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-results
          path: |
            test-results/
            playwright-report/visual-results.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Storybook Build
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: storybook-static
          path: storybook-static/
          retention-days: 1

      # Deploy Playwright reports to GitHub Pages
      - name: Check Playwright Report Exists
        id: check-report
        if: always()
        run: |
          if [ -d "playwright-report" ] && [ -f "playwright-report/index.html" ]; then
            echo "report-exists=true" >> $GITHUB_OUTPUT
            echo "✅ Playwright report found"
          else
            echo "report-exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Playwright report not found - skipping deployment"
          fi

      - name: Setup Pages
        if: steps.check-report.outputs.report-exists == 'true'
        uses: actions/configure-pages@v4

      - name: Upload Pages Artifact
        if: steps.check-report.outputs.report-exists == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: playwright-report/

      - name: Deploy to GitHub Pages
        if: steps.check-report.outputs.report-exists == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Skipped
        if: steps.check-report.outputs.report-exists != 'true'
        run: |
          echo "⚠️ Deployment skipped: Playwright report not available"
          echo "This is normal if visual regression tests were skipped or failed before report generation"

  # ============================================
  # Note: E2E Tests are run in a separate repository
  # against deployed applications (K8s environment)
  # See TEST_DEPLOYMENT_STRATEGY.md for details
  # 
  # Playwright test reports are automatically deployed to GitHub Pages
  # after visual regression tests complete (if report exists)
  # ============================================

  # ============================================
  # Summary Job (Shows overall status)
  # ============================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [
      lint-and-typecheck,
      unit-tests,
      integration-tests,
      smoke-tests,
      visual-regression-tests
    ]
    if: always()
    
    steps:
      - name: Check CI Status
        run: |
          echo "✅ CI Pipeline Completed"
          echo "Check individual job results above for details"
